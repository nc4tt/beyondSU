name: Build KernelSU Kernel Module

on:
  workflow_call:
    inputs:
      kmi:
        description: 'KMI version'
        required: true
        type: string
      ddk_release:
        description: 'DDK release version'
        required: false
        default: '20251104'
        type: string

jobs:
  build-kernelsu-ko:
    name: Build kernelsu.ko for ${{ inputs.kmi }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ylarod/ddk:${{ inputs.kmi }}-${{ inputs.ddk_release }}
      options: --privileged

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build kernelsu.ko
      run: |
        git config --global --add safe.directory /__w/YukiSU/YukiSU
        cd kernel

        echo "=== Building kernelsu.ko for KMI: ${{ inputs.kmi }} ==="
        CONFIG_KSU=m CONFIG_KSU_MANUAL_SU=y CONFIG_KSU_SUPERKEY=y CC=clang make
        
        echo "=== Build completed ==="
        # Create output directory in GitHub workspace
        mkdir -p /github/workspace/out
        # Copy with KMI-specific naming
        OUTPUT_NAME="${{ inputs.kmi }}_kernelsu.ko"
        cp kernelsu.ko "/github/workspace/out/$OUTPUT_NAME"
        
        echo "Copied to: /github/workspace/out/$OUTPUT_NAME"
        ls -la "/github/workspace/out/$OUTPUT_NAME"
        echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
        echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
        
    - name: Install GPG
      run: |
        apt-get update && apt-get install -y gnupg

    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        fingerprint: "348C368D028B3271B84EB798AD251FCA1EBBCEEE"
        trust_level: 5

    - name: Sign kernelsu.ko with GPG
      run: |
        cd /github/workspace/out
        KO_FILE="${{ inputs.kmi }}_kernelsu.ko"
        echo "Signing $KO_FILE..."
        gpg --detach-sign --local-user an@anatdx.com --batch --yes --pinentry-mode loopback \
          --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
          --output "${KO_FILE}.sig" "$KO_FILE"
        if [ -f "${KO_FILE}.sig" ]; then
          echo "Signature created successfully"
          ls -lh "${KO_FILE}.sig"
        else
          echo "Error: Signature file not created!"
          exit 1
        fi

    - name: Upload kernelsu.ko artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.kmi }}-lkm
        path: |
          /github/workspace/out/${{ inputs.kmi }}_kernelsu.ko
          /github/workspace/out/${{ inputs.kmi }}_kernelsu.ko.sig