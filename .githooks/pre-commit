#!/bin/bash
# Pre-commit hook for YukiSU
# Automatically formats C/C++ code and adds #endif comments

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

# Get list of staged C/C++/H files
STAGED_C_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h)$' | grep -v tools/ || true)
STAGED_CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp)$' || true)

if [ -n "$STAGED_C_FILES" ] || [ -n "$STAGED_CPP_FILES" ]; then
    echo "[pre-commit] Formatting staged C/C++ files..."
    
    # Format kernel C files
    if [ -n "$STAGED_C_FILES" ]; then
        for file in $STAGED_C_FILES; do
            if [ -f "$REPO_ROOT/$file" ]; then
                echo "  Formatting: $file"
                clang-format -i "$REPO_ROOT/$file"
            fi
        done
    fi
    
    # Format userspace C++ files
    if [ -n "$STAGED_CPP_FILES" ]; then
        for file in $STAGED_CPP_FILES; do
            if [ -f "$REPO_ROOT/$file" ]; then
                echo "  Formatting: $file"
                clang-format -i "$REPO_ROOT/$file"
            fi
        done
    fi
    
    # Add #endif comments using Python script
    ENDIF_SCRIPT="$REPO_ROOT/.githooks/fix_endif_comments.py"
    if [ -f "$ENDIF_SCRIPT" ]; then
        echo "[pre-commit] Adding #endif comments..."
        ALL_FILES="$STAGED_C_FILES $STAGED_CPP_FILES"
        for file in $ALL_FILES; do
            if [ -f "$REPO_ROOT/$file" ]; then
                python3 "$ENDIF_SCRIPT" "$REPO_ROOT/$file"
            fi
        done
    fi
    
    # Re-add formatted files to staging
    for file in $STAGED_C_FILES $STAGED_CPP_FILES; do
        if [ -f "$REPO_ROOT/$file" ]; then
            git add "$REPO_ROOT/$file"
        fi
    done
    
    echo "[pre-commit] Done!"
fi

exit 0
